{% extends "base.html" %}
{% load bootstrap3 %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'private_messages/style.css' %}" />

{% block javascript %}
  <script>
    function cancelMessage(){
      document.getElementById('new-message-div').classList.add('hidden')
      document.getElementById('new-message-button').classList.remove('hidden')
    }
    document.getElementById('cancel-message').addEventListener('click', cancelMessage);

    $('.email-button').on('click',function(e){
      e.preventDefault();
      var that = $(this)
      var emailButtonId = that.attr('id').slice(13,that.attr('id').length)
      that.parent().addClass('hidden')
      that.parent().parent().append("<form id='email-form-"+emailButtonId+"' class='email-message' method='post'><div class='col-md-2'><input id='email-subject-"+emailButtonId+"' class='form-control' type='text' placeholder='subject' value=''></div><div class='form-group'><textarea id='email-message-"+emailButtonId+"' class='form-control' rows='4' placeholder='message' value=''></textarea></div><input type='submit' value='send email' name='submit'></form>")
    })

    $('.reply-button').on('click',function(e){
      e.preventDefault();
      var that = $(this)
      var replyButtonId = that.attr('id').slice(13,that.attr('id').length)
      that.parent().addClass('hidden')
      that.parent().parent().append("<form id='reply-form-"+replyButtonId+"' class='reply-message' method='post'><div class='col-md-2'><input id='reply-subject-"+replyButtonId+"' class='form-control' type='text' placeholder='subject' value=''></div><div class='form-group'><textarea id='reply-message-"+replyButtonId+"' class='form-control' rows='4' placeholder='message' value=''></textarea></div><input type='submit' value='send message' name='submit'></form>")
    })

    $('.inbox-messages').on('submit', 'form', function(e) {
      e.preventDefault();
      var that = $(this)
      var recipientId = that.prev().prev().attr('id').slice(10,that.prev().prev().attr('id').length)
      if (that.attr('class') == 'reply-message'){
        var msgId = that.attr('id').slice(11,that.attr('id').length)
        var subject = document.getElementById('reply-subject-'+msgId).value;
        var message = document.getElementById('reply-message-'+msgId).value;
        sendReply();
        function sendReply() {
          $.ajax({
            url  : '{% url 'private_messages:new_message' %}',
            type : "POST",
            data : {
              recipient : recipientId,
              subject : subject,
              message : message
            },
            beforeSend: function (xhr) {
              xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            success : function() {
              document.getElementById('reply-form-'+msgId).classList.add('hidden');
              document.getElementById('inbox-options-'+msgId).classList.remove('hidden')
            }
          })
        }
      } else if (that.attr('class') == 'email-message') {
        var subject = document.getElementById('email-subject-'+msgId).value;
        var message = document.getElementById('email-message-'+msgId).value;
        var msgId = that.attr('id').slice(11,that.attr('id').length)
        sendEmail();
        function sendEmail() {
          $.ajax({
            url  : '{% url 'accounts:email' %}',
            type : "POST",
            data : {
              recipient : recipientId,
              subject : subject,
              message : message
            },
            beforeSend: function (xhr) {
              xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            success : function() {
              document.getElementById('email-form-'+msgId).classList.add('hidden');
              document.getElementById('inbox-options-'+msgId).classList.remove('hidden')
            }
          })
        }
      } else if (that.attr('class') == 'text-message') {
        var msgId = that.attr('id').slice(10,that.attr('id').length)
        var message = document.getElementById('text-message-'+msgId).value;
        sendText();
        function sendText() {
          $.ajax({
            url  : '{% url 'private_messages:text' %}',
            type : "POST",
            data : {
              recipient : recipientId,
              message : message
            },
            beforeSend: function (xhr) {
              xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            success : function() {
              document.getElementById('text-form-'+msgId).classList.add('hidden');
              document.getElementById('inbox-options-'+msgId).classList.remove('hidden')
            }
          })
        }
      }
    })

    $('#new-message-button').on('click',function(e){
      $('#new-message-div').removeClass('hidden');
      $('#new-message-button').addClass('hidden');
    })

    $('.inbox-messages').on('click','a',function(e){
      that = $(this)
      if (that.attr('class') == "pm-delete") {
        e.preventDefault();
        delete_message();
      }

      function delete_message(){
        $.ajax({
          url  : that.attr('href'),
          type : "DELETE",
          beforeSend: function (xhr) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
          },
          success : function(json) {
            document.getElementById('inbox-message-'+json.pk).remove()
            document.getElementById('outbox-message-'+json.pk).remove()
          }
        })
      }
    })

    $('#new-message-div').on('submit','form',function(e){
      e.preventDefault();
      that = $(this)
      sendMessage();

      function sendMessage(){
        $.ajax({
          url  : '{% url 'private_messages:new_message' %}',
          type : "POST",
          data : { recipient: $('#id_recipient').val(), subject: $('#id_subject').val(), message: $('#id_message').val() },
          beforeSend: function (xhr) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
          },
          success : function(json) {
            document.getElementById('new-message-div').classList.add('hidden')
            document.getElementById('id_recipient').value = '';
            document.getElementById('id_subject').value = '';
            document.getElementById('id_message').value = '';
            $('#new-message-button').removeClass('hidden');
            if (json.recipient_id == json.sender_id) {
              $('.inbox-messages').prepend("<div id='inbox-message-"+json.message_pk+"'><h3 id='subject_line'>subject: <a class='inbox-msg-"+json.message_pk+"' href='/messages/details/"+json.message_pk+"/'>"+json.subject+"</a></h3><p>sent by: "+json.username+"</a></p><p><a class='pm-delete' href='/messages/delete/"+json.message_pk+"/' title='delete' class='btn btn-simple'><span class='glyphicon glyphicon-remove text-danger'></span><span class='text-danger icon-label'>Delete</span></a></p></div>")
              $('.outbox-messages').prepend("<div id='outbox-message-"+json.message_pk+"'><h3 id='subject_line'>subject: <a class='outbox-msg-"+json.message_pk+"' href='/messages/details/"+json.message_pk+"/'>"+json.subject+"</a></h3><p>sent to: "+json.recipient+"</a></p></div>")
            } else {
              $('.outbox-messages').prepend("<div id='outbox-message-"+json.message_pk+"'><h3 id='subject_line'>subject: <a class='outbox-msg-"+json.message_pk+"' href='/messages/details/"+json.message_pk+"/'>"+json.subject+"</a></h3><p>sent to: "+json.recipient+"</a></p></div>")
            }
          }
        })
      }
    })

    $('.text-button').on('click', function(e){
      e.preventDefault();
      var that = $(this)
      var textId = that.attr('id').slice(12,that.attr('id').length)
      var contactList = document.getElementById('inbox-options-'+textId)
      contactList.classList.add('hidden')
      that.parent().parent().append("<form id='text-form-"+textId+"' class='text-message' method='post'><div class='form-group'><textarea id='text-message-"+textId+"' class='form-control' rows='4' placeholder='message' value=''></textarea></div><input type='submit' value='send text' name='submit'></form>")
    })
  </script>
{% endblock %}

{% block content %}
  <div class="new-message">
    <h1>Inbox</h1>
    <a id="new-message-button" href="#">New Message</a>
    <div id='new-message-div' class='hidden'>
      <h1>New Message</h1>
      <form method="post">
        {% csrf_token %}
        {% bootstrap_form message_form %}
        <p>
          <input type='submit' class='btn btn-primary' value='Send Message'>
          <button id="cancel-message" class='btn btn-primary' type="button" name="button">Cancel</button>
        </p>
      </form>
    </div>
  </div>
  <div class="inbox-messages">
    {% for message in users_inbox  %}
      {% include "private_messages/_inbox_message.html" %}
    {% endfor %}
  </div>
  <h1>Sent Messages</h1>
  <div class="outbox-messages">
    {% for message in users_outbox  %}
      {% include "private_messages/_sent_message.html" %}
    {% endfor %}
  </div>
{% endblock %}
